compiler = g++-10
compiler_cmd = $(compiler) -std=c++20
{% for target in targets %}
{% if target.phony %}
.PHONY: {{ target.phony.name }}
{{ target.phony.name }}: {{ target.program }}
	{{ target.phony.command }}
{% endif %}

{{ target.program }}:{% for object in target.objects %} {{ object.file }}{% endfor %}
	$(compiler_cmd){% for object in target.objects %} {{ object.file }}{% endfor %} -LDependencies/lib -Wl,-rpath='$$ORIGIN' -lpthread {{ target.link_options }} -o {{ target.program }}

{% for object in target.objects %}
{{ object.file }}:{% for source_file in object.sources_needed %} {{source_file}}{% endfor %}
	@mkdir -p $(@D)
	$(compiler_cmd) {{ target.compile_options }} -IDependencies/include -c {{ object.source }} -o {{ object.file}}
{% endfor %}
{% endfor %}


{% for source_generator in source_generators %}
{{source_generator.outputs[0]}} : {{source_generator.source}}
	python3 Tools/source_generator.py {{ source_generator.source }}

{% for output in source_generator.outputs[1:] %}
{{output}} : {{source_generator.outputs[0]}}
{%- endfor %}
{%- endfor %}

.PHONY: regenerate
regenerate:
	python3 Tools/makefile_generator.py
