# TEST BEGIN
# TEST NAME A rule relying on the judgemental equality of a match computes, even where the rule must be applied multiple times.
# TEST MUST_COMPILE

block {
  axiom Bool : Type;
  axiom yes : Bool;
  axiom no : Bool;

  axiom Maybe : Type -> Type;
  axiom some : (T : Type) -> T -> Maybe T;
  axiom none : (T : Type) -> Maybe T;

  axiom Fam : Bool -> Type;
  axiom yes_fam : Fam yes;
  axiom no_fam : Fam no;

  declare weird : (f : Bool -> Bool) -> Fam (f (f yes)) -> Maybe (Fam yes);
  weird f x = match(f yes) {
    yes -> some _ x;
    no -> match(f no) {
      yes -> some _ x;
      no -> none _;
    };
  };

  declare not : Bool -> Bool;
  not yes = no;
  not no = yes;

  verify weird not yes_fam = some _ yes_fam;
  verify weird (\.yes) yes_fam = some _ yes_fam;
  verify weird (\.no) no_fam = none (Fam yes);

  yes
}
